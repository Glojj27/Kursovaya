<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 250px;
            background: #343a40;
            color: white;
            padding: 20px 0;
        }
        
        .sidebar-heading {
            padding: 0 20px;
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .nav-link {
            display: block;
            padding: 12px 20px;
            color: #adb5bd;
            text-decoration: none;
            border-left: 3px solid transparent;
        }
        
        .nav-link:hover,
        .nav-link.active {
            color: white;
            background: #495057;
            border-left-color: #007bff;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            background: #f8f9fa;
            overflow-y: auto;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .file-upload {
            border: 2px dashed #007bff;
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        
        th {
            background-color: #343a40;
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .developer-info {
            text-align: center;
            padding: 20px;
        }
        
        .developer-photo {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #007bff;
            margin-bottom: 15px;
        }
        
        .chart-container {
            height: 400px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .help-section {
            margin-bottom: 30px;
        }
        
        .help-section h4 {
            color: #007bff;
            margin-bottom: 10px;
        }
        
        .download-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-heading">
            <span>–ú–µ–Ω—é</span>
        </div>
        <ul style="list-style: none; padding: 0; margin: 0;">
            <li><a class="nav-link active" href="#" data-tab="upload">üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫</a></li>
            <li><a class="nav-link" href="#" data-tab="edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞</a></li>
            <li><a class="nav-link" href="#" data-tab="stats_table">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç–∞–±–ª–∏—Ü—ã)</a></li>
            <li><a class="nav-link" href="#" data-tab="stats_graph">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≥—Ä–∞—Ñ–∏–∫–∏)</a></li>
            <li><a class="nav-link" href="#" data-tab="help">‚ùì –ü–æ–º–æ—â—å</a></li>
            <li><a class="nav-link" href="#" data-tab="about">‚ÑπÔ∏è –û –ø—Ä–æ–≥—Ä–∞–º–º–µ</a></li>
        </ul>
    </nav>

    <!-- Main content -->
    <main class="main-content">
        <!-- Upload Tab -->
        <div id="upload" class="tab-content active">
            <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫ –∏–∑ —Ñ–∞–π–ª–∞</h2>
            <div class="card">
                <div class="file-upload">
                    <input type="file" id="fileInput" accept=".csv,.txt,.xlsx,.xls">
                    <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                    <p class="text-muted">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: CSV, TXT, XLSX, XLS</p>
                </div>
                <button class="btn" onclick="loadSampleData()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö</button>
                
                <div id="fileInfo" style="margin-top: 20px;"></div>
            </div>
            
            <div class="card">
                <h3>–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</h3>
                <div id="uploadedTable"></div>
            </div>
        </div>

        <!-- Edit Tab -->
        <div id="edit" class="tab-content">
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞</h2>
            <div class="card">
                <h4>–î–æ–±–∞–≤–∏—Ç—å/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —É—á–µ–Ω–∏–∫–∞</h4>
                <div class="form-group">
                    <label>–ö–ª–∞—Å—Å:</label>
                    <input type="text" id="studentClass" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 10A, 11B –∏ —Ç.–¥.">
                </div>
                <div class="form-group">
                    <label>–§–ò–û —É—á–µ–Ω–∏–∫–∞:</label>
                    <input type="text" id="studentName" class="form-control">
                </div>
                <div class="form-group">
                    <label>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞:</label>
                    <input type="number" id="mathGrade" class="form-control" min="1" max="5">
                </div>
                <div class="form-group">
                    <label>–†—É—Å—Å–∫–∏–π —è–∑—ã–∫:</label>
                    <input type="number" id="russianGrade" class="form-control" min="1" max="5">
                </div>
                <div class="form-group">
                    <label>–§–∏–∑–∏–∫–∞:</label>
                    <input type="number" id="physicsGrade" class="form-control" min="1" max="5">
                </div>
                <div class="form-group">
                    <label>–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞:</label>
                    <input type="number" id="literatureGrade" class="form-control" min="1" max="5">
                </div>
                
                <button class="btn" onclick="addStudent()">–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</button>
                <button class="btn" onclick="updateStudent()">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <button class="btn" onclick="deleteStudent()">–£–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞</button>
                
                <div class="download-buttons">
                    <button class="btn" onclick="downloadJournal('csv')">üì• –°–∫–∞—á–∞—Ç—å CSV</button>
                    <button class="btn" onclick="downloadJournal('excel')">üì• –°–∫–∞—á–∞—Ç—å Excel</button>
                    <button class="btn" onclick="downloadJournal('txt')">üì• –°–∫–∞—á–∞—Ç—å TXT</button>
                </div>
            </div>
            
            <div class="card">
                <h3>–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫</h3>
                <div id="gradeTable"></div>
            </div>
        </div>

        <!-- Stats Table Tab -->
        <div id="stats_table" class="tab-content">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ç–∞–±–ª–∏—á–Ω–æ–º –≤–∏–¥–µ</h2>
            <div class="card">
                <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–ª–∞—Å—Å–∞–º</h4>
                <div id="classStatsTable"></div>
            </div>
            <div class="card">
                <h4>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –∫–ª–∞—Å—Å–∞–º</h4>
                <div id="overallStatsTable"></div>
            </div>
        </div>

        <!-- Stats Graph Tab -->
        <div id="stats_graph" class="tab-content">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–º –≤–∏–¥–µ</h2>
            <div class="card">
                <h4>–°—Ä–µ–¥–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏ –ø–æ –∫–ª–∞—Å—Å–∞–º</h4>
                <div class="chart-container">
                    <canvas id="classAvgChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</h4>
                <div class="chart-container">
                    <canvas id="gradeDistributionChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h4>–û–±—â–∞—è —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</h4>
                <div class="chart-container">
                    <canvas id="overallPerformanceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Help Tab -->
        <div id="help" class="tab-content">
            <h2>–ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h2>
            
            <div class="card help-section">
                <h4>üìÅ –í–∫–ª–∞–¥–∫–∞ "–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ü–µ–Ω–æ–∫"</h4>
                <p>–ü—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∞ CSV, TXT, XLSX.</p>
                <p><strong>–§–æ—Ä–º–∞—Ç CSV —Ñ–∞–π–ª–∞:</strong></p>
                <pre>–ö–ª–∞—Å—Å,–§–ò–û,–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞,–†—É—Å—Å–∫–∏–π —è–∑—ã–∫,–§–∏–∑–∏–∫–∞,–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞
10A,–ò–≤–∞–Ω–æ–≤ –ê.–ò.,5,4,5,4
10A,–ü–µ—Ç—Ä–æ–≤–∞ –°.–ö.,4,5,4,5</pre>
            </div>

            <div class="card help-section">
                <h4>‚úèÔ∏è –í–∫–ª–∞–¥–∫–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞"</h4>
                <p>–ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª—è—Ç—å, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å –∑–∞–ø–∏—Å–∏ –æ–± —É—á–µ–Ω–∏–∫–∞—Ö.</p>
                <p>–î–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã, –≤–Ω–µ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –Ω–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ".</p>
                <p><strong>–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–µ–Ω–∏–∫–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –≤—Ä—É—á–Ω—É—é</strong>, –Ω–∞–ø—Ä–∏–º–µ—Ä: 10A, 11B, 9–í –∏ —Ç.–¥.</p>
            </div>

            <div class="card help-section">
                <h4>üìä –í–∫–ª–∞–¥–∫–∞ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç–∞–±–ª–∏—Ü—ã)"</h4>
                <p>–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ –ø–æ –∫–ª–∞—Å—Å–∞–º –∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º:</p>
                <ul>
                    <li>–°—Ä–µ–¥–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏</li>
                    <li>–ú–µ–¥–∏–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è</li>
                    <li>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç —É—á–µ–Ω–∏–∫–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –æ—Ü–µ–Ω–∫–∏</li>
                </ul>
            </div>

            <div class="card help-section">
                <h4>üìà –í–∫–ª–∞–¥–∫–∞ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–≥—Ä–∞—Ñ–∏–∫–∏)"</h4>
                <p>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –≤–∏–¥–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∏ –¥–∏–∞–≥—Ä–∞–º–º.</p>
            </div>
        </div>

        <!-- About Tab -->
        <div id="about" class="tab-content">
            <h2>–û –ø—Ä–æ–≥—Ä–∞–º–º–µ</h2>
            <div class="card">
                <div class="developer-info">
                    <img src="https://via.placeholder.com/150" alt="–§–æ—Ç–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞" class="developer-photo" id="developerPhoto">
                    <h3>–õ–∞—Ä–∏–Ω –ù–∏–∫–∏—Ç–∞ –ê–ª–µ–∫—Å–µ–µ–≤–∏—á</h3>
                    <p><strong>–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–≥–æ –∂—É—Ä–Ω–∞–ª–∞ –æ—Ü–µ–Ω–æ–∫</strong></p>
                    <p>üìß Email: nik_larin_04@mail.ru</p>
                    <p>üìû –¢–µ–ª–µ—Ñ–æ–Ω: +7 (999) 123-45-67</p>
                    <p>üåê GitHub: github.com/glojj27</p>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>–û –ø—Ä–æ–≥—Ä–∞–º–º–µ</h4>
                    <p>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫ v2.0</p>
                    <p>–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ —É—á–∞—â–∏—Ö—Å—è</p>
                    <p>–§—É–Ω–∫—Ü–∏–∏: –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö, —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</p>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let students = [];
        let selectedStudentIndex = null;
        let charts = {};

        // –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–º–µ–Ω–∞ –ø–æ–ª–µ–π
        const FIELD_NAMES = {
            class: '–ö–ª–∞—Å—Å',
            name: '–§–ò–û',
            math: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',
            russian: '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫',
            physics: '–§–∏–∑–∏–∫–∞',
            literature: '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞'
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–º–µ–Ω –ø–æ–ª–µ–π
        function normalizeFieldName(fieldName) {
            const field = fieldName.trim();
            const mappings = {
                '–ö–ª–∞—Å—Å': FIELD_NAMES.class,
                '–§–ò–û': FIELD_NAMES.name,
                '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞': FIELD_NAMES.math,
                'Math': FIELD_NAMES.math,
                '–†—É—Å—Å–∫–∏–π_—è–∑—ã–∫': FIELD_NAMES.russian,
                '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫': FIELD_NAMES.russian,
                'Russian': FIELD_NAMES.russian,
                '–§–∏–∑–∏–∫–∞': FIELD_NAMES.physics,
                'Physics': FIELD_NAMES.physics,
                '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞': FIELD_NAMES.literature,
                'Literature': FIELD_NAMES.literature
            };
            
            return mappings[field] || field;
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤
        function getUniqueClasses() {
            const classes = new Set();
            students.forEach(student => {
                if (student[FIELD_NAMES.class]) {
                    const className = student[FIELD_NAMES.class].toString().trim();
                    if (className) {
                        classes.add(className);
                    }
                }
            });
            return Array.from(classes).sort();
        }

        class GradeJournal {
            constructor() {
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.showTab('upload');
                this.renderAllTables();
            }

            setupEventListeners() {
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tab = e.target.getAttribute('data-tab');
                        this.showTab(tab);
                    });
                });

                document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            }

            showTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });

                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });

                document.getElementById(tabName).classList.add('active');
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                if (tabName === 'stats_table') {
                    this.renderStatsTables();
                } else if (tabName === 'stats_graph') {
                    setTimeout(() => this.renderCharts(), 100);
                }
            }

            renderAllTables() {
                this.renderUploadedTable();
                this.renderGradeTable();
                this.updateFileInfo();
            }

            renderUploadedTable() {
                const container = document.getElementById('uploadedTable');
                container.innerHTML = this.generateTableHTML(students);
            }

            renderGradeTable() {
                const container = document.getElementById('gradeTable');
                container.innerHTML = this.generateTableHTML(students, true);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ —Å—Ç—Ä–æ–∫–∏
                setTimeout(() => {
                    const rows = container.querySelectorAll('tbody tr');
                    rows.forEach((row, index) => {
                        row.addEventListener('click', () => this.selectStudent(row, index));
                    });
                }, 0);
            }

            renderStatsTables() {
                this.renderClassStatsTable();
                this.renderOverallStatsTable();
            }

            renderClassStatsTable() {
                const container = document.getElementById('classStatsTable');
                const classes = getUniqueClasses();
                const subjects = [FIELD_NAMES.math, FIELD_NAMES.russian, FIELD_NAMES.physics, FIELD_NAMES.literature];

                if (classes.length === 0 || students.length === 0) {
                    container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
                    return;
                }

                let html = '<table><tr><th>–ö–ª–∞—Å—Å</th><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–°—Ä–µ–¥–Ω—è—è</th><th>–ú–µ–¥–∏–∞–Ω–∞</th>';
                for (let i = 1; i <= 5; i++) {
                    html += `<th>${i} (–∫–æ–ª-–≤–æ)</th><th>${i} (%)</th>`;
                }
                html += '</tr>';

                classes.forEach(className => {
                    subjects.forEach(subject => {
                        const classStudents = students.filter(s => s[FIELD_NAMES.class] === className);
                        const stats = this.calculateSubjectStats(classStudents, subject);
                        html += `<tr>
                            <td>${className}</td>
                            <td>${subject}</td>
                            <td>${stats.average.toFixed(2)}</td>
                            <td>${stats.median.toFixed(2)}</td>`;
                        for (let i = 1; i <= 5; i++) {
                            html += `<td>${stats.gradeCount[i] || 0}</td>
                                    <td>${stats.gradePercent[i] || '0.00'}%</td>`;
                        }
                        html += '</tr>';
                    });
                });

                html += '</table>';
                container.innerHTML = html;
            }

            renderOverallStatsTable() {
                const container = document.getElementById('overallStatsTable');
                const subjects = [FIELD_NAMES.math, FIELD_NAMES.russian, FIELD_NAMES.physics, FIELD_NAMES.literature];

                if (students.length === 0) {
                    container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
                    return;
                }

                let html = '<table><tr><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–°—Ä–µ–¥–Ω—è—è</th><th>–ú–µ–¥–∏–∞–Ω–∞</th>';
                for (let i = 1; i <= 5; i++) {
                    html += `<th>${i} (–∫–æ–ª-–≤–æ)</th><th>${i} (%)</th>`;
                }
                html += '</tr>';

                subjects.forEach(subject => {
                    const stats = this.calculateSubjectStats(students, subject);
                    html += `<tr>
                        <td>${subject}</td>
                        <td>${stats.average.toFixed(2)}</td>
                        <td>${stats.median.toFixed(2)}</td>`;
                    for (let i = 1; i <= 5; i++) {
                        html += `<td>${stats.gradeCount[i] || 0}</td>
                                <td>${stats.gradePercent[i] || '0.00'}%</td>`;
                    }
                    html += '</tr>';
                });

                html += '</table>';
                container.innerHTML = html;
            }

            calculateSubjectStats(studentsList, subject) {
                const grades = studentsList.map(s => {
                    const grade = s[subject];
                    return grade ? parseInt(grade) : NaN;
                }).filter(g => !isNaN(g));
                
                if (grades.length === 0) return { average: 0, median: 0, gradeCount: {}, gradePercent: {} };

                const average = grades.reduce((a, b) => a + b, 0) / grades.length;
                
                const sorted = [...grades].sort((a, b) => a - b);
                const median = sorted.length % 2 === 0 
                    ? (sorted[sorted.length/2 - 1] + sorted[sorted.length/2]) / 2 
                    : sorted[Math.floor(sorted.length/2)];

                const gradeCount = {};
                const gradePercent = {};
                for (let i = 1; i <= 5; i++) {
                    gradeCount[i] = grades.filter(g => g === i).length;
                    gradePercent[i] = ((gradeCount[i] / grades.length) * 100).toFixed(2);
                }

                return { average, median, gradeCount, gradePercent };
            }

            renderCharts() {
                this.destroyCharts();
                this.renderClassAvgChart();
                this.renderGradeDistributionChart();
                this.renderOverallPerformanceChart();
            }

            destroyCharts() {
                Object.values(charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                charts = {};
            }

            renderClassAvgChart() {
                const ctx = document.getElementById('classAvgChart').getContext('2d');
                const classes = getUniqueClasses();
                const subjects = [FIELD_NAMES.math, FIELD_NAMES.russian, FIELD_NAMES.physics, FIELD_NAMES.literature];

                if (classes.length === 0 || students.length === 0) {
                    ctx.canvas.parentElement.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</p>';
                    return;
                }

                const datasets = subjects.map((subject, index) => {
                    const data = classes.map(className => {
                        const classStudents = students.filter(s => s[FIELD_NAMES.class] === className);
                        const grades = classStudents.map(s => {
                            const grade = s[subject];
                            return grade ? parseInt(grade) : NaN;
                        }).filter(g => !isNaN(g));
                        
                        return grades.length > 0 ? (grades.reduce((a, b) => a + b, 0) / grades.length) : 0;
                    });

                    const colors = [
                        'rgb(255, 99, 132)',
                        'rgb(54, 162, 235)',
                        'rgb(255, 205, 86)',
                        'rgb(75, 192, 192)'
                    ];

                    return {
                        label: subject,
                        data: data,
                        borderColor: colors[index],
                        backgroundColor: colors[index] + '20',
                        tension: 0.4,
                        fill: false
                    };
                });

                charts.classAvg = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: classes,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5,
                                title: {
                                    display: true,
                                    text: '–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '–ö–ª–∞—Å—Å—ã'
                                }
                            }
                        }
                    }
                });
            }

            renderGradeDistributionChart() {
                const ctx = document.getElementById('gradeDistributionChart').getContext('2d');
                const subjects = [FIELD_NAMES.math, FIELD_NAMES.russian, FIELD_NAMES.physics, FIELD_NAMES.literature];
                
                if (students.length === 0) {
                    ctx.canvas.parentElement.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</p>';
                    return;
                }

                const datasets = [];
                const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'];

                for (let grade = 1; grade <= 5; grade++) {
                    const data = subjects.map(subject => {
                        const grades = students.map(s => {
                            const g = s[subject];
                            return g ? parseInt(g) : NaN;
                        }).filter(g => !isNaN(g));
                        
                        return grades.filter(g => g === grade).length;
                    });

                    datasets.push({
                        label: `–û—Ü–µ–Ω–∫–∞ ${grade}`,
                        data: data,
                        backgroundColor: colors[grade-1],
                        borderColor: colors[grade-1],
                        borderWidth: 1
                    });
                }

                charts.gradeDistribution = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: subjects,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '–ü—Ä–µ–¥–º–µ—Ç—ã'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ü–µ–Ω–æ–∫'
                                },
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }

            renderOverallPerformanceChart() {
                const ctx = document.getElementById('overallPerformanceChart').getContext('2d');
                const subjects = [FIELD_NAMES.math, FIELD_NAMES.russian, FIELD_NAMES.physics, FIELD_NAMES.literature];
                
                if (students.length === 0) {
                    ctx.canvas.parentElement.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞</p>';
                    return;
                }

                const averages = subjects.map(subject => {
                    const grades = students.map(s => {
                        const grade = s[subject];
                        return grade ? parseInt(grade) : NaN;
                    }).filter(g => !isNaN(g));
                    
                    return grades.length > 0 ? (grades.reduce((a, b) => a + b, 0) / grades.length) : 0;
                });

                charts.overallPerformance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: subjects,
                        datasets: [{
                            label: '–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞',
                            data: averages,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5,
                                title: {
                                    display: true,
                                    text: '–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '–ü—Ä–µ–¥–º–µ—Ç—ã'
                                }
                            }
                        }
                    }
                });
            }

            generateTableHTML(data, selectable = false) {
                if (data.length === 0) {
                    return '<p>–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>';
                }

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
                const headers = [FIELD_NAMES.class, FIELD_NAMES.name, FIELD_NAMES.math, 
                               FIELD_NAMES.russian, FIELD_NAMES.physics, FIELD_NAMES.literature];
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                ${headers.map(header => `<th>${header}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach((row, index) => {
                    const selected = selectable && index === selectedStudentIndex ? 'style="background-color: #e3f2fd;"' : '';
                    html += `<tr ${selected}>`;
                    headers.forEach(header => {
                        html += `<td>${row[header] || ''}</td>`;
                    });
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            selectStudent(row, index) {
                document.querySelectorAll('#gradeTable tr').forEach(r => {
                    r.style.backgroundColor = '';
                });
                row.style.backgroundColor = '#e3f2fd';
                selectedStudentIndex = index;

                const student = students[index];
                document.getElementById('studentClass').value = student[FIELD_NAMES.class] || '';
                document.getElementById('studentName').value = student[FIELD_NAMES.name] || '';
                document.getElementById('mathGrade').value = student[FIELD_NAMES.math] || '';
                document.getElementById('russianGrade').value = student[FIELD_NAMES.russian] || '';
                document.getElementById('physicsGrade').value = student[FIELD_NAMES.physics] || '';
                document.getElementById('literatureGrade').value = student[FIELD_NAMES.literature] || '';
            }

            updateFileInfo() {
                const container = document.getElementById('fileInfo');
                if (students.length > 0) {
                    const classes = getUniqueClasses();
                    container.innerHTML = `
                        <p><strong>–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π:</strong> ${students.length}</p>
                        <p><strong>–ö–ª–∞—Å—Å—ã:</strong> ${classes.join(', ')}</p>
                        <p><strong>–ü—Ä–µ–¥–º–µ—Ç—ã:</strong> ${[FIELD_NAMES.math, FIELD_NAMES.russian, FIELD_NAMES.physics, FIELD_NAMES.literature].join(', ')}</p>
                    `;
                } else {
                    container.innerHTML = '<p>–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>';
                }
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function loadSampleData() {
            students = [
                { [FIELD_NAMES.class]: "10A", [FIELD_NAMES.name]: "–ò–≤–∞–Ω–æ–≤ –ê.–ò.", [FIELD_NAMES.math]: 5, [FIELD_NAMES.russian]: 4, [FIELD_NAMES.physics]: 5, [FIELD_NAMES.literature]: 4 },
                { [FIELD_NAMES.class]: "10A", [FIELD_NAMES.name]: "–ü–µ—Ç—Ä–æ–≤–∞ –°.–ö.", [FIELD_NAMES.math]: 4, [FIELD_NAMES.russian]: 5, [FIELD_NAMES.physics]: 4, [FIELD_NAMES.literature]: 5 },
                { [FIELD_NAMES.class]: "10B", [FIELD_NAMES.name]: "–°–∏–¥–æ—Ä–æ–≤ –î.–ú.", [FIELD_NAMES.math]: 3, [FIELD_NAMES.russian]: 4, [FIELD_NAMES.physics]: 4, [FIELD_NAMES.literature]: 3 },
                { [FIELD_NAMES.class]: "10B", [FIELD_NAMES.name]: "–ö–æ–∑–ª–æ–≤–∞ –ú.–ü.", [FIELD_NAMES.math]: 5, [FIELD_NAMES.russian]: 3, [FIELD_NAMES.physics]: 5, [FIELD_NAMES.literature]: 4 },
                { [FIELD_NAMES.class]: "11A", [FIELD_NAMES.name]: "–ù–∏–∫–æ–ª–∞–µ–≤ –í.–°.", [FIELD_NAMES.math]: 4, [FIELD_NAMES.russian]: 4, [FIELD_NAMES.physics]: 3, [FIELD_NAMES.literature]: 5 },
                { [FIELD_NAMES.class]: "11A", [FIELD_NAMES.name]: "–û—Ä–ª–æ–≤–∞ –ï.–î.", [FIELD_NAMES.math]: 5, [FIELD_NAMES.russian]: 5, [FIELD_NAMES.physics]: 5, [FIELD_NAMES.literature]: 4 }
            ];
            gradeJournal.renderAllTables();
            alert('–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∂–µ–Ω!');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                parseExcel(file);
            } else if (fileExtension === 'csv' || fileExtension === 'txt') {
                parseTextFile(file);
            } else {
                alert('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ CSV, TXT, XLSX –∏–ª–∏ XLS.');
            }
        }

        function parseTextFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    parseCSV(content);
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + error.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length === 0) {
                        alert('–§–∞–π–ª Excel –ø—É—Å—Ç–æ–π');
                        return;
                    }
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel –≤ —Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç, —á—Ç–æ –∏ CSV
                    const rawHeaders = jsonData[0];
                    const headers = rawHeaders.map(normalizeFieldName);
                    
                    students = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row && row.length > 0) {
                            const record = {};
                            rawHeaders.forEach((rawHeader, index) => {
                                const normalizedHeader = normalizeFieldName(rawHeader);
                                record[normalizedHeader] = row[index] ? row[index].toString().trim() : '';
                            });
                            
                            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
                            if (!record[FIELD_NAMES.class]) record[FIELD_NAMES.class] = '';
                            if (!record[FIELD_NAMES.name]) record[FIELD_NAMES.name] = '';
                            
                            students.push(record);
                        }
                    }
                    
                    gradeJournal.renderAllTables();
                    alert(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${students.length} –∑–∞–ø–∏—Å–µ–π –∏–∑ Excel —Ñ–∞–π–ª–∞`);
                    
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ Excel —Ñ–∞–π–ª–∞: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseCSV(content) {
            const lines = content.split('\n').filter(line => line.trim());
            if (lines.length === 0) {
                alert('–§–∞–π–ª –ø—É—Å—Ç–æ–π');
                return;
            }

            const rawHeaders = lines[0].split(',').map(h => h.trim());
            const headers = rawHeaders.map(normalizeFieldName);
            
            students = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    if (values.length === rawHeaders.length) {
                        const record = {};
                        rawHeaders.forEach((rawHeader, index) => {
                            const normalizedHeader = normalizeFieldName(rawHeader);
                            record[normalizedHeader] = values[index].trim();
                        });
                        
                        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è
                        if (!record[FIELD_NAMES.class]) record[FIELD_NAMES.class] = '';
                        if (!record[FIELD_NAMES.name]) record[FIELD_NAMES.name] = '';
                        
                        students.push(record);
                    }
                }
            }

            gradeJournal.renderAllTables();
            alert(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${students.length} –∑–∞–ø–∏—Å–µ–π`);
        }

        function addStudent() {
            const className = document.getElementById('studentClass').value.trim();
            const name = document.getElementById('studentName').value.trim();
            
            if (!className) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞');
                return;
            }
            
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –§–ò–û —É—á–µ–Ω–∏–∫–∞');
                return;
            }

            const newStudent = {
                [FIELD_NAMES.class]: className,
                [FIELD_NAMES.name]: name,
                [FIELD_NAMES.math]: document.getElementById('mathGrade').value || '',
                [FIELD_NAMES.russian]: document.getElementById('russianGrade').value || '',
                [FIELD_NAMES.physics]: document.getElementById('physicsGrade').value || '',
                [FIELD_NAMES.literature]: document.getElementById('literatureGrade').value || ''
            };

            students.push(newStudent);
            clearForm();
            gradeJournal.renderAllTables();
        }

        function updateStudent() {
            if (selectedStudentIndex === null) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return;
            }

            const className = document.getElementById('studentClass').value.trim();
            const name = document.getElementById('studentName').value.trim();
            
            if (!className) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞');
                return;
            }
            
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –§–ò–û —É—á–µ–Ω–∏–∫–∞');
                return;
            }

            students[selectedStudentIndex] = {
                [FIELD_NAMES.class]: className,
                [FIELD_NAMES.name]: name,
                [FIELD_NAMES.math]: document.getElementById('mathGrade').value || '',
                [FIELD_NAMES.russian]: document.getElementById('russianGrade').value || '',
                [FIELD_NAMES.physics]: document.getElementById('physicsGrade').value || '',
                [FIELD_NAMES.literature]: document.getElementById('literatureGrade').value || ''
            };

            clearForm();
            gradeJournal.renderAllTables();
            selectedStudentIndex = null;
        }

        function deleteStudent() {
            if (selectedStudentIndex === null) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }

            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–µ–Ω–∏–∫–∞?')) {
                students.splice(selectedStudentIndex, 1);
                clearForm();
                gradeJournal.renderAllTables();
                selectedStudentIndex = null;
            }
        }

        function downloadJournal(format) {
            if (students.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                return;
            }

            const headers = [FIELD_NAMES.class, FIELD_NAMES.name, FIELD_NAMES.math, 
                           FIELD_NAMES.russian, FIELD_NAMES.physics, FIELD_NAMES.literature];
            
            switch(format) {
                case 'csv':
                    downloadCSV(headers);
                    break;
                case 'excel':
                    downloadExcel(headers);
                    break;
                case 'txt':
                    downloadTXT(headers);
                    break;
                default:
                    alert('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
            }
        }

        function downloadCSV(headers) {
            // –î–æ–±–∞–≤–ª—è–µ–º BOM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
            const BOM = '\uFEFF';
            
            const csvContent = [
                headers.join(','),
                ...students.map(row => 
                    headers.map(header => {
                        const value = row[header] || '';
                        // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø—è—Ç—ã–µ
                        if (value.toString().includes(',') || value.toString().includes('"')) {
                            return '"' + value.toString().replace(/"/g, '""') + '"';
                        }
                        return value;
                    }).join(',')
                )
            ].join('\n');
            
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            downloadFile(blob, 'journal.csv');
        }

        function downloadExcel(headers) {
            try {
                // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Excel
                const worksheetData = [
                    headers,
                    ...students.map(row => headers.map(header => row[header] || ''))
                ];
                
                // –°–æ–∑–¥–∞–µ–º —Ä–∞–±–æ—á—É—é –∫–Ω–∏–≥—É
                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫
                const colWidths = headers.map(() => ({ wch: 20 }));
                worksheet['!cols'] = colWidths;
                
                // –°–æ–∑–¥–∞–µ–º –∫–Ω–∏–≥—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –ª–∏—Å—Ç
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "–ñ—É—Ä–Ω–∞–ª –æ—Ü–µ–Ω–æ–∫");
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª
                const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([excelBuffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                downloadFile(blob, 'journal.xlsx');
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Excel —Ñ–∞–π–ª–∞: ' + error.message);
            }
        }

        function downloadTXT(headers) {
            // –§–æ—Ä–º–∏—Ä—É–µ–º TXT —Ñ–∞–π–ª —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º –≤ –≤–∏–¥–µ –∑–∞–ø—è—Ç–æ–π (CSV —Ñ–æ—Ä–º–∞—Ç –≤ TXT)
            const txtContent = [
                headers.join(','),
                ...students.map(row => 
                    headers.map(header => row[header] || '').join(',')
                )
            ].join('\n');
            
            const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8;' });
            downloadFile(blob, 'journal.txt');
        }

        function downloadFile(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function clearForm() {
            document.getElementById('studentClass').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('mathGrade').value = '';
            document.getElementById('russianGrade').value = '';
            document.getElementById('physicsGrade').value = '';
            document.getElementById('literatureGrade').value = '';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let gradeJournal;
        document.addEventListener('DOMContentLoaded', () => {
            gradeJournal = new GradeJournal();
        });
    </script>
</body>
</html>